# 消息折叠插件 (Message Toggle) v1.6

这是一个为 SillyTavern 设计的前端插件，它允许用户在聊天界面中折叠或展开单条消息，以方便浏览长对话。此版本包含动态自动折叠功能、通过常驻按钮访问的中文设置面板，并使用浏览器的本地存储 (`localStorage`) 持久保存消息的折叠状态。

## 功能特性

*   在每条聊天消息的**开始处**和**结束处**添加可点击的三角按钮 (▼/▶)。
*   点击任一按钮可以折叠/展开该条消息的内容区域（另一按钮状态会同步）。
*   使用浏览器的 `localStorage` **持久化存储**消息的折叠状态（切换角色、关闭浏览器后状态会保留）。
*   在页面右侧提供一个**常驻的“设置”按钮**，用于打开和关闭设置面板。
*   提供一个**全中文**的设置面板，包含以下配置选项：
    *   **动态自动折叠**：启用后，当 AI 发送新消息导致展开的消息总数超过设定值时，自动折叠最旧的已展开消息，以维持设定的展开数量。
    *   **按 ID 范围操作**：批量折叠或展开指定 `mesid` 范围内的消息。
    *   **按特定 ID 操作**：批量折叠或展开逗号分隔的特定 `mesid` 或 `mesid` 范围的消息。
*   **纯前端实现**：仅修改浏览器端的视觉显示，**完全不影响**发送给 AI 模型处理的上下文内容或聊天记录本身。
*   采用 `display: none` 方式隐藏消息内容，**确保内容不被裁剪**（折叠/展开时无平滑动画）。

## 安装方法

1.  确保你已经关闭了 SillyTavern。
2.  找到你的 SillyTavern 安装目录。
3.  导航到 `public/extensions/` 文件夹。
4.  在此文件夹内创建一个名为 `message-toggle` 的新文件夹（如果还没有的话）。
5.  将以下**三个**文件放入你刚刚创建（或确认存在）的 `message-toggle` 文件夹中：
    *   `script.js` （包含插件的主要逻辑和设置面板功能）
    *   `style.css` （包含按钮样式、折叠效果、设置面板和常驻按钮的样式）
    *   `manifest.json` （插件的清单文件）
6.  重新启动 SillyTavern。
7.  打开任意聊天界面。插件应该已经自动生效。
    *   你应该能在每条消息的开始和结束处看到折叠按钮。
    *   你应该能在页面右侧看到一个竖排的“设置”按钮。
    *   如果界面元素未出现或不正确，请尝试**强制刷新**一次浏览器页面（通常按 `Ctrl+Shift+R` 或 `Cmd+Shift+R`）。

## 使用方法

*   **折叠/展开消息**：点击消息开始处或结束处的三角按钮即可切换该消息的显示状态。
*   **访问设置**：点击页面右侧边缘的竖排“**设置**”按钮，即可打开设置面板。再次点击该按钮或面板内的关闭/取消按钮可以关闭面板。

## 设置面板详解

设置面板提供以下选项（所有设置更改需点击“保存并关闭”才会生效并保存，仅“立即按此规则整理”按钮会即时生效）：

1.  **动态自动折叠旧消息**
    *   **启用复选框**：勾选此项以启用动态自动折叠功能。
    *   **保留最新的展开条数**：输入一个数字 N。启用此功能后，每当 AI 发送新消息，如果当前展开的消息总数超过 N，插件会自动折叠最旧的**已展开**消息，使得展开的消息数量维持在 N 左右。
    *   **立即按此规则整理**：点击此按钮，会根据当前设置的保留数量，**一次性地**将当前聊天中所有早于保留数量的消息全部折叠起来。这主要用于初次启用设置或希望手动整理现有聊天记录时使用。

2.  **按消息 ID 折叠/展开范围**
    *   **起始 ID**：输入要操作的消息范围的第一个 `mesid`。
    *   **结束 ID**：输入要操作的消息范围的最后一个 `mesid`。
    *   **折叠范围 / 展开范围**：点击对应按钮，对指定 `mesid` 范围内的所有消息执行折叠或展开操作。

3.  **按特定 ID 折叠/展开**
    *   **输入框**：输入你想要操作的消息的 `mesid`，可以用逗号分隔多个 ID，也可以使用连字符表示范围（例如：`5, 8, 12-15, 20`）。
    *   **折叠指定 / 展开指定**：点击对应按钮，对输入框中指定的所有消息执行折叠或展开操作。

4.  **底部按钮**
    *   **保存并关闭**：保存当前面板中的设置（自动折叠启用状态和保留数量），并关闭面板。
    *   **取消**：关闭面板，不保存本次在面板中对设置的更改。

## 技术说明

*   **状态存储**: 使用浏览器的 `localStorage` API 保存每条消息的折叠状态 (键: `sillytavern_msg_toggle_角色或用户名_消息ID`) 和插件设置 (键: `sillytavern_msg_toggle_settings`)。
*   **依赖**: 插件依赖于 SillyTavern 聊天消息的特定 HTML 结构：
    *   消息容器：`<div class="mes">`
    *   消息内容：`<div class="mes_text">`
    *   必需属性：`mesid`, `ch_name`, `is_user`
    *   聊天区域容器：`<div id="chat">` (用于监听新消息)
*   **实现**:
    *   `script.js`: 使用 `MutationObserver` 监听新消息并添加双按钮；管理设置面板的创建、显示/隐藏、数据填充和保存；处理常驻设置按钮的点击事件；执行动态自动折叠逻辑（在 AI 消息添加后触发）以及手动的范围/特定 ID 折叠/展开操作。
    *   `style.css`: 定义消息折叠按钮、设置面板、常驻设置按钮的样式，并使用 `display: none;` 实现无动画的消息折叠。

## 注意事项与排错

*   **如果按钮/设置面板不出现或功能异常**:
    1.  按 `F12` 打开浏览器开发者工具，检查“**控制台 (Console)**”标签页是否有红色的错误信息。
    2.  确认 `manifest.json`, `script.js`, `style.css` 三个文件都在 `public/extensions/message-toggle/` 目录下，且文件名无误。
    3.  确认 `manifest.json` 文件内容正确。
    4.  使用开发者工具的“**检查元素 (Inspect Element)**”功能，确认聊天消息的 HTML 结构是否与预期一致（类名、属性名）。
    5.  尝试强制刷新页面 (`Ctrl+Shift+R`) 或清除浏览器缓存。
*   **如果状态没有被保存**:
    1.  确保浏览器没有禁用 `localStorage`。
    2.  检查控制台是否有与 `localStorage` 相关的错误。
*   **兼容性**: SillyTavern 的未来更新可能会改变前端结构，导致插件失效，届时需要更新插件代码。
*   **插件冲突**: 与其他修改聊天界面或使用 `localStorage` 的插件可能存在冲突。

