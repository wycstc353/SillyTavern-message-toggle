
# SillyTavern 消息折叠插件 (Message Toggle)

这是一个为 SillyTavern 设计的前端插件，它允许用户在聊天界面中折叠或展开单条消息，以方便浏览长对话。消息的折叠状态会被持久保存在浏览器的本地存储 (`localStorage`) 中。

## 功能特性

*   在每条聊天消息（包括用户发送和角色回应）旁边添加一个可点击的三角按钮 (▼/▶)。
*   点击按钮可以折叠该条消息的内容区域，再次点击则展开。
*   消息的折叠状态使用浏览器的 `localStorage` 进行持久化存储。这意味着：
    *   当你切换角色或重新加载聊天时，之前折叠的消息会保持折叠状态。
    *   即使关闭浏览器或重启电脑后再次打开，折叠状态也会被记住。
*   **纯前端实现**：仅修改浏览器端的视觉显示，**完全不影响**发送给 AI 模型处理的上下文内容或聊天记录本身。

## 安装方法

1.  确保你已经关闭了 SillyTavern。
2.  找到你的 SillyTavern 安装目录。
3.  导航到 `public/extensions/` 文件夹。
4.  在此文件夹内创建一个名为 `message-toggle` 的新文件夹（如果还没有的话）。
5.  将以下三个文件放入你刚刚创建（或确认存在）的 `message-toggle` 文件夹中：
    *   `script.js` （包含插件的主要逻辑）
    *   `style.css` （包含按钮样式和折叠/展开的视觉效果）
    *   `manifest.json` （插件的清单文件，告诉 SillyTavern 如何加载它）
6.  重新启动 SillyTavern。
7.  打开任意聊天界面。插件应该已经自动生效。你可能需要**强制刷新**一次浏览器页面（通常按 `Ctrl+Shift+R` 或 `Cmd+Shift+R`）以确保加载最新的脚本和样式。

## 使用方法

安装并启用插件后，在聊天窗口的每条消息旁边（默认是在左上角附近，具体位置由 `style.css` 控制）应该能看到一个小的三角按钮。

*   **点击向下的三角 (▼)**：该条消息的内容会被折叠起来，三角会变成向右的 (▶)。
*   **点击向右的三角 (▶)**：该条消息的内容会重新展开，三角变回向下 (▼)。

操作会实时生效，并且状态会被自动保存。

## 技术说明

*   **状态存储**: 插件使用浏览器的 `localStorage` API 来保存每条消息的折叠状态。存储的键 (Key) 是根据插件定义的**前缀**、消息所属的**角色名或用户名** (`ch_name` 属性) 以及消息的**唯一ID** (`mesid` 属性) 组合生成的。例如：`sillytavern_msg_toggle_角色名_消息ID`。
*   **依赖**: 插件的运行依赖于 SillyTavern 聊天消息的 HTML 结构，特别是以下元素和属性：
    *   消息容器：具有 `class="mes"` 的 `div` 元素。
    *   消息内容容器：具有 `class="mes_text"` 的 `div` 元素。
    *   必需属性：`mesid` (消息ID), `ch_name` (角色/用户名), `is_user` (判断是否用户消息)。
    *   聊天区域容器：具有 `id="chat"` 的元素 (用于 MutationObserver 监听新消息)。
*   **实现**:
    *   `script.js`: 使用 `MutationObserver` 监听聊天区域的新消息添加，动态地为每条符合条件的消息注入按钮，并绑定点击事件。点击事件处理函数负责切换 CSS 类 (`.collapsed`) 来控制显隐，并同步更新 `localStorage` 中的状态。初始化时会读取 `localStorage` 来恢复之前的折叠状态。
    *   `style.css`: 定义了 `.message-toggle-button` 的样式（外观、定位、鼠标效果、三角图标切换）以及 `.mes_text.collapsed` 的样式（通过 `max-height` 和 `opacity` 实现带动画的折叠效果）。

## 注意事项与排错

*   **如果按钮不出现或点击无效**:
    1.  按 `F12` 打开浏览器开发者工具，检查“**控制台 (Console)**”标签页是否有红色的错误信息，特别是提到 `message-toggle`, `script.js` 或 `localStorage` 相关的错误。
    2.  确认 `manifest.json`, `script.js`, `style.css` 三个文件都在 `public/extensions/message-toggle/` 目录下，且文件名无误。
    3.  确认 `manifest.json` 文件内容正确（特别是 `js` 和 `css` 字段指向的文件名）。
    4.  使用开发者工具的“**检查元素 (Inspect Element)**”功能，确认聊天消息的 HTML 结构是否仍然使用 `.mes` 类作为容器，`.mes_text` 类作为内容，并且是否还存在 `mesid` 和 `ch_name` 属性。如果 SillyTavern 版本更新导致结构变化，需要相应修改 `script.js` 中的选择器和属性名。
*   **如果状态没有被保存**:
    1.  确保你的浏览器没有禁用 `localStorage` 功能（通常是默认开启的）。
    2.  检查开发者工具“控制台”是否有与 `localStorage` 写入/读取相关的错误。可能是存储空间已满（虽然可能性较小）或有其他插件冲突。
*   **兼容性**: 此插件是基于开发时所用的 SillyTavern 版本编写的。未来的 SillyTavern 更新**可能**会改变其前端 HTML 结构或类名，导致插件失效。届时需要更新插件代码以适应新版本。
*   **插件冲突**: 如果你同时使用了其他修改聊天界面外观或行为的插件，可能会存在样式覆盖或功能冲突。

---

希望这份说明能帮助你更好地使用和理解这个插件！
